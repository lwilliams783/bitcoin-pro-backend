import express from â€œexpressâ€;
import fetch from â€œnode-fetchâ€;
import cors from â€œcorsâ€;

const app = express();

// CORS - simple and clean
app.use(cors({ origin: â€œ*â€ }));

// Cache to avoid hitting APIs too often
let cache = {
data: null,
timestamp: 0
};

const CACHE_DURATION = 30000; // 30 seconds

app.get(â€/marketsâ€, async (req, res) => {
try {
console.log(â€œğŸ“Š Markets endpoint calledâ€);

```
// Return cached data if fresh
if (cache.data && Date.now() - cache.timestamp < CACHE_DURATION) {
  console.log("âœ… Returning cached data");
  return res.json(cache.data);
}

console.log("ğŸ”„ Fetching fresh data...");

// Fetch all data in parallel
const [btcData, goldData, yahooData] = await Promise.all([
  // Bitcoin from Binance (with CoinGecko fallback)
  fetch("https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT")
    .then(r => r.json())
    .then(data => {
      console.log("âœ… Binance response:", data.lastPrice);
      return data;
    })
    .catch(err => {
      console.error("âŒ Binance error:", err.message);
      console.log("ğŸ”„ Trying CoinGecko fallback...");
      return fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true&include_24hr_vol=true")
        .then(r => r.json())
        .catch(() => null);
    }),
  
  // Gold from Metals.live
  fetch("https://api.metals.live/v1/spot/gold")
    .then(r => r.json())
    .then(data => ({ price: data[0] }))
    .catch(() => {
      console.warn("âš ï¸ Gold API failed, using fallback");
      return { price: 2650 };
    }),
  
  // Yahoo Finance for DXY, Russell 2000, VIX
  Promise.all([
    fetch("https://query1.finance.yahoo.com/v8/finance/chart/DX-Y.NYB?interval=1d&range=1d")
      .then(r => r.json())
      .catch(() => null),
    fetch("https://query1.finance.yahoo.com/v8/finance/chart/%5ERUT?interval=1d&range=1d")
      .then(r => r.json())
      .catch(() => null),
    fetch("https://query1.finance.yahoo.com/v8/finance/chart/%5EVIX?interval=1d&range=1d")
      .then(r => r.json())
      .catch(() => null),
    fetch("https://query1.finance.yahoo.com/v8/finance/chart/%5ETNX?interval=1d&range=1d")
      .then(r => r.json())
      .catch(() => null),
    fetch("https://query1.finance.yahoo.com/v8/finance/chart/%5ETYX?interval=1d&range=1d")
      .then(r => r.json())
      .catch(() => null)
  ])
]);

// Parse Bitcoin data from Binance OR CoinGecko
let bitcoin = {
  price: 95000,
  change24h: 2.5,
  volume24h: "45.0",
  marketCap: "1852.50"
};

if (btcData && btcData.lastPrice) {
  // Binance format
  const price = parseFloat(btcData.lastPrice);
  const change = parseFloat(btcData.priceChangePercent);
  const volume = parseFloat(btcData.volume);
  
  bitcoin = {
    price: Math.round(price),
    change24h: parseFloat(change.toFixed(2)),
    volume24h: ((volume * price) / 1000000000).toFixed(1),
    marketCap: (price * 19.5 / 1000).toFixed(2)
  };
  console.log("âœ… Binance BTC:", bitcoin.price, "Change:", bitcoin.change24h + "%");
} else if (btcData && btcData.bitcoin) {
  // CoinGecko format
  const price = btcData.bitcoin.usd;
  const change = btcData.bitcoin.usd_24h_change;
  const volume = btcData.bitcoin.usd_24h_vol;
  
  bitcoin = {
    price: Math.round(price),
    change24h: parseFloat(change.toFixed(2)),
    volume24h: (volume / 1000000000).toFixed(1),
    marketCap: (price * 19.5 / 1000).toFixed(2)
  };
  console.log("âœ… CoinGecko BTC:", bitcoin.price, "Change:", bitcoin.change24h + "%");
} else {
  console.warn("âš ï¸ Using fallback BTC data");
}

// Parse Gold
const gold = Math.round(goldData.price || 2650);

// Parse Yahoo data with warnings
const dxy = yahooData[0]?.chart?.result?.[0]?.meta?.regularMarketPrice?.toFixed(2) || "109.07";
const rut = Math.round(yahooData[1]?.chart?.result?.[0]?.meta?.regularMarketPrice || 2582);
const vix = yahooData[2]?.chart?.result?.[0]?.meta?.regularMarketPrice?.toFixed(2) || "14.67";
const us10y = yahooData[3]?.chart?.result?.[0]?.meta?.regularMarketPrice?.toFixed(2) || "4.18";
const us30y = yahooData[4]?.chart?.result?.[0]?.meta?.regularMarketPrice?.toFixed(2) || "4.81";

if (!yahooData[0]) console.warn("âš ï¸ Yahoo DXY failed");
if (!yahooData[1]) console.warn("âš ï¸ Yahoo RUT failed");
if (!yahooData[2]) console.warn("âš ï¸ Yahoo VIX failed");

// Build response
const responseData = {
  bitcoin,
  gold,
  dxy: parseFloat(dxy),
  rut,
  vix: parseFloat(vix),
  us2y: 3.54,
  us10y: parseFloat(us10y),
  us20y: parseFloat(us30y),
  timestamp: new Date().toISOString()
};

// Cache it
cache = {
  data: responseData,
  timestamp: Date.now()
};

console.log("âœ… Response ready, sending to client");
res.json(responseData);
```

} catch (e) {
console.error(â€œâŒ FATAL ERROR:â€, e.message);
console.error(e.stack);
res.status(500).json({
error: â€œFailed to fetch market dataâ€,
message: e.message,
timestamp: new Date().toISOString()
});
}
});

// Health check
app.get(â€/â€, (req, res) => {
res.json({
status: â€œokâ€,
message: â€œBitcoin Pro API is runningâ€,
endpoints: [â€/marketsâ€]
});
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
console.log(`âœ… Server running on port ${PORT}`);
});
